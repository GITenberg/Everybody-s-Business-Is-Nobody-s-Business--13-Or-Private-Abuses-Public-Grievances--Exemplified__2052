sudo: required
dist: trusty
language: ruby

before_install:
- gem install asciidoctor -v 1.5.2
- gem install tilt
- sudo pip install git+https://github.com/gitenberg-dev/gitberg
- sudo pip install git+https://github.com/gitenberg-dev/pg-epubmaker
script:
- VERSION=`ruby -e "require 'yaml'; meta = YAML.load_file('metadata.yaml'); puts meta['_version'];"`
- git clone https://github.com/gitenberg-dev/asciidoctor-htmlbook.git
- sudo pip install -r asciidoctor-htmlbook/gitberg-machine/requirements.txt

- /usr/bin/python -c "from gitenberg import travis; travis.build_epub()"
- ebook-convert book.epub book.mobi
- xvfb-run ebook-convert book.epub book.pdf
notifications:
  webhooks:
    urls:
      - https://unglue.it/api/travisci/webhook
    on_success: always
    on_failure: never
    on_start: never
deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: iM3xd/YJPOlmKLcWRmvDWo5ZpT6mWiq6T14qbHBH1/3wWksvtP9PLzsIU4NaQ+pu5JsIOAbE1tnef79HrkcZ0lwr0ofp+0ONeucK3dGedLWs1usYYuRDEL/NI+ijC0aYXrDeMWnV8PohEpunqQGyulG4R3Lz6JaA5tiIZ/RjGlBczFxyQ02Chn1605tsF7o544//yEMiZP1zATcGNKPpSIxWyVK7n0EZ9/mblZqegAs+UgC8XKI/1CUJ9BALoeI5hZqjKqytE/hMN2vv3xXuU0q1dI5XYT6XsC+uBf9C01DP/2FG55omQD+U9pmJ0kgIH2CFhpn2Bwjs8SB5kmQw38ZKZJhTMRZE+N0wqDh/gFJiYOhuvBihEF1WYNbtJfXDH7nKLKjmRB7WHyta15DZrT9Ond3IIQuFV4CnencXQ20yVxIQt2BVpef2GiyuXz3Vrb22Dfp/Hsd1aYQd+sarrQZBB056DYSIJJKRMkQNk4kAVKePLgQoyWH8dIBgd2KxPscPuKydkK5+cy4n+Jh1t4DYAdS9AwaDwFpiKXTrUbVmuofbFvZKRU0thjPokRCKV8arKy8Fpge1/q1taWIbPYQmrggugLnQ6gxxq31hfbe3bNXQucpTOwxEP19V2r8YAuSFcKzI2Ht4W+lPjHaiuEL+u0SvC/QXrw6NGvr2Esk=
  file:
    - book.epub
    - book.mobi
    - book.pdf
  on:
    repo: GITenberg/Everybody-s-Business-Is-Nobody-s-Business--13-Or-Private-Abuses-Public-Grievances--Exemplified__2052
    tags: true
addons:
  apt:
    packages:
    - xsltproc
    - xvfb
    - calibre
    - python-pip
    - git
    - python-dev
    - libjpeg-dev
    - libpng-dev
    - libfreetype6
    - libfreetype6-dev
    - zlib1g-dev
    - python-lxml
    - libxml2-dev
    - libxslt1-dev
    - tidy